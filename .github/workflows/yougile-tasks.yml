name: YouGile Tasks
on:
  issues:
    types: [opened, reopened, closed]
jobs:
  create-yougile-task:
    name: Create YouGile task
    if: github.event.action == 'opened' || github.event.action == 'reopened'
    runs-on: ubuntu-22.04
    permissions:
      issues: write
    steps:
      - id: create-task
        run: |
          curl -sS --request POST \
            --url https://ru.yougile.com/api-v2/tasks \
            --header 'Authorization: Bearer ${{ secrets.YOUGILE_API_KEY }}' \
            --header 'Content-Type: application/json' \
            --data '{
              "title": "${{ github.event.issue.title }}",
              "columnId": "${{ secrets.YOUGILE_COLUMN_ID }}",
              "description": "<a href=\"https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}\">Показать в Github</a>"
            }' | jq -r '.id'
      - run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "YouGile task ID: `${{ steps.create-task.outputs.stdout }}`"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
  mark-complete-yougile-task:
    name: Mark YouGile task is completed
    if: github.event.action == 'closed'
    runs-on: ubuntu-22.04
    steps:
      - run: |
          curl --request PUT \
            --url https://ru.yougile.com/api-v2/tasks/1 \
            --header 'Authorization: Bearer ${{ secrets.YOUGILE_API_KEY }}' \
            --header 'Content-Type: application/json' \
            --data '{
              "completed": true
            }'
